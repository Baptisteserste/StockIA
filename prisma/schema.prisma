generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String        @id @unique
  email     String
  credits   Int           @default(10)
  createdAt DateTime      @default(now())
  analyses  AnalysisLog[]
}

model AnalysisLog {
  id        String   @id @default(cuid())
  userId    String
  symbol    String
  cost      Float
  tokens    Int
  sentiment String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model SimulationConfig {
  id             String           @id @default(cuid())
  symbol         String
  startCapital   Float
  cheapModelId   String
  premiumModelId String
  useReddit      Boolean          @default(false)
  durationDays   Int              @default(21)
  status         SimulationStatus @default(IDLE)
  currentDay     Int              @default(0)
  createdBy      String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  snapshots      MarketSnapshot[]
  portfolios     Portfolio[]

  @@index([status])
}

model MarketSnapshot {
  id              String           @id @default(cuid())
  simulationId    String
  timestamp       DateTime         @default(now())
  symbol          String
  price           Float
  sentimentScore  Float
  sentimentReason String
  rsi             Float?
  macd            Float?
  redditHype      Float?
  decisions       BotDecision[]
  simulation      SimulationConfig @relation(fields: [simulationId], references: [id], onDelete: Cascade)

  @@index([simulationId, timestamp])
}

model BotDecision {
  id         String         @id @default(cuid())
  snapshotId String
  botType    BotType
  action     TradeAction
  quantity   Float
  price      Float
  reason     String
  confidence Float?
  algoConfig Json?
  createdAt  DateTime       @default(now())
  snapshot   MarketSnapshot @relation(fields: [snapshotId], references: [id], onDelete: Cascade)

  @@index([botType, createdAt])
}

model Portfolio {
  id           String           @id @default(cuid())
  simulationId String
  botType      BotType
  cash         Float
  shares       Float
  avgBuyPrice  Float?
  totalValue   Float
  roi          Float
  updatedAt    DateTime         @updatedAt
  simulation   SimulationConfig @relation(fields: [simulationId], references: [id], onDelete: Cascade)

  @@unique([simulationId, botType])
}

enum SimulationStatus {
  IDLE
  RUNNING
  COMPLETED
}

enum BotType {
  CHEAP
  PREMIUM
  ALGO
}

enum TradeAction {
  BUY
  SELL
  HOLD
}
